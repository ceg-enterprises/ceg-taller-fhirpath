<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Taller FHIRPath - Conectaton HL7 Chile 2025</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Dark theme (default) */
    :root {
      --bg-primary: #0a0e14;
      --bg-secondary: #0d1219;
      --bg-tertiary: #131a24;
      --bg-card: #151d28;
      --border-color: #1e2a3a;
      --border-highlight: #2a3a4d;
      --text-primary: #e6edf3;
      --text-secondary: #8b949e;
      --text-muted: #5c6670;
      --hl7-blue: #0066a1;
      --hl7-blue-light: #0080c9;
      --success-green: #00a86b;
      --success-green-light: #00c97f;
      --accent-orange: #ff6b35;
      --accent-orange-light: #ff8555;
      --error-red: #f85149;
      --chile-red: #d52b1e;
      --json-key: #79c0ff;
      --json-string: #a5d6ff;
      --json-number: #00c97f;
      --json-boolean: #ff7b72;
      --json-null: #8b949e;
    }

    /* Light theme */
    [data-theme="light"] {
      --bg-primary: #ffffff;
      --bg-secondary: #f6f8fa;
      --bg-tertiary: #eef1f4;
      --bg-card: #ffffff;
      --border-color: #d1d9e0;
      --border-highlight: #b8c1cc;
      --text-primary: #1a1a2e;
      --text-secondary: #5a6a7a;
      --text-muted: #8b949e;
      --hl7-blue: #0066a1;
      --hl7-blue-light: #0080c9;
      --success-green: #00875a;
      --success-green-light: #00a86b;
      --accent-orange: #e85a2c;
      --accent-orange-light: #ff6b35;
      --error-red: #d32f2f;
      --chile-red: #d52b1e;
      --json-key: #0550ae;
      --json-string: #0a3069;
      --json-number: #00875a;
      --json-boolean: #cf222e;
      --json-null: #8b949e;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Background grid */
    .bg-grid {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image:
        linear-gradient(rgba(0, 102, 161, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 102, 161, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
      pointer-events: none;
      z-index: 0;
    }

    .container {
      position: relative;
      z-index: 1;
      max-width: 1800px;
      margin: 0 auto;
      padding: 0.75rem 1.5rem;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Header */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 0.5rem;
      flex-shrink: 0;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo-ceg {
      height: 40px;
      width: auto;
    }

    .header-title {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 1.25rem;
      font-weight: 600;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .server-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.75rem;
    }

    .server-status .dot {
      width: 8px;
      height: 8px;
      background: var(--text-muted);
      border-radius: 50%;
      transition: background 0.3s ease;
    }

    .server-status.connected .dot {
      background: var(--success-green);
      box-shadow: 0 0 8px var(--success-green);
    }

    .theme-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .theme-toggle:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .theme-toggle svg {
      width: 18px;
      height: 18px;
    }

    .theme-toggle .sun-icon { display: none; }
    .theme-toggle .moon-icon { display: block; }
    [data-theme="light"] .theme-toggle .sun-icon { display: block; }
    [data-theme="light"] .theme-toggle .moon-icon { display: none; }

    /* Progress bar */
    .progress-container {
      margin-bottom: 0.5rem;
      flex-shrink: 0;
    }

    .progress-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .progress-title {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .progress-counter {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .progress-bar {
      display: flex;
      gap: 4px;
      height: 6px;
    }

    .progress-segment {
      flex: 1;
      background: var(--bg-tertiary);
      border-radius: 3px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .progress-segment:hover {
      background: var(--border-highlight);
    }

    .progress-segment.active {
      background: var(--hl7-blue);
    }

    .progress-segment.completed {
      background: var(--success-green);
    }

    .progress-segment.error {
      background: var(--error-red);
    }

    /* Main content */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    /* Step card */
    .step-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 0.5rem;
      transition: all 0.3s ease;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .step-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1.25rem;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
    }

    .step-header-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .step-number-badge {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--hl7-blue) 0%, #004d7a 100%);
      border-radius: 8px;
      font-family: 'IBM Plex Mono', monospace;
      font-weight: 600;
      font-size: 1rem;
      color: white;
      flex-shrink: 0;
    }

    .step-title-group h2 {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 0.1rem;
    }

    .step-subtitle {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .step-subtitle .method {
      color: var(--json-key);
      font-weight: 600;
    }

    .step-category {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.35rem 0.75rem;
      background: rgba(0, 102, 161, 0.15);
      border-radius: 100px;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--hl7-blue-light);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .step-category.searchparam {
      background: rgba(0, 168, 107, 0.15);
      color: var(--success-green-light);
    }

    /* Step content */
    .step-content {
      display: grid;
      grid-template-columns: 40% 60%;
      gap: 1rem;
      padding: 0.75rem 1rem;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    @media (max-width: 1000px) {
      .step-content {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }
    }

    /* Info panel */
    .info-panel {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      overflow-y: auto;
      padding-right: 0.5rem;
    }

    .info-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1.25rem 1.5rem;
      flex-shrink: 0;
    }

    .info-section-title {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 0.875rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-color);
    }

    .info-section p {
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.65;
      margin-bottom: 0.75rem;
    }

    .info-section p:last-child {
      margin-bottom: 0;
    }

    .info-highlight {
      background: rgba(0, 102, 161, 0.08);
      border-left: 3px solid var(--hl7-blue);
      padding: 0.75rem 1rem;
      border-radius: 0 8px 8px 0;
      margin-top: 0.875rem;
      font-size: 0.85rem;
      line-height: 1.6;
    }

    .info-highlight.warning {
      background: rgba(255, 107, 53, 0.08);
      border-left-color: var(--accent-orange);
    }

    .info-highlight.success {
      background: rgba(0, 168, 107, 0.08);
      border-left-color: var(--success-green);
    }

    .info-highlight code {
      background: var(--bg-primary);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.8rem;
      color: var(--json-key);
      display: inline-block;
      margin: 0.15rem 0;
    }

    /* Note style for function explanations */
    .info-note {
      background: var(--bg-tertiary);
      border: 1px dashed var(--border-highlight);
      border-radius: 8px;
      padding: 0.875rem 1rem;
      margin-top: 0.75rem;
      font-size: 0.8rem;
      color: var(--text-secondary);
      line-height: 1.7;
    }


    .info-note strong {
      color: var(--hl7-blue-light);
      font-weight: 600;
    }

    .info-note code {
      background: var(--bg-primary);
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.75rem;
      color: var(--json-key);
    }

    /* Execute button */
    .execute-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      width: 100%;
      padding: 0.6rem 1rem;
      background: linear-gradient(135deg, var(--hl7-blue) 0%, #004d7a 100%);
      border: none;
      border-radius: 8px;
      color: white;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      flex-shrink: 0;
      margin-top: auto;
    }

    .execute-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 102, 161, 0.3);
    }

    .execute-btn:active {
      transform: translateY(0);
    }

    .execute-btn.loading {
      opacity: 0.7;
      pointer-events: none;
    }

    .execute-btn.success {
      background: linear-gradient(135deg, var(--success-green) 0%, #007a4d 100%);
    }

    .execute-btn.error {
      background: linear-gradient(135deg, var(--error-red) 0%, #c62828 100%);
    }

    .execute-btn svg {
      width: 20px;
      height: 20px;
    }

    .execute-btn.loading svg {
      animation: spin 1s linear infinite;
    }

    /* Response panel */
    .response-panel {
      display: flex;
      flex-direction: column;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
      min-height: 0;
    }

    .response-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.4rem 0.75rem;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
    }

    .response-toolbar-left {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .toolbar-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .toolbar-dot:nth-child(1) { background: #ff5f57; }
    .toolbar-dot:nth-child(2) { background: #febc2e; }
    .toolbar-dot:nth-child(3) { background: #28c840; }

    .response-endpoint {
      margin-left: 0.5rem;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.65rem;
      color: var(--text-muted);
    }

    .status-badge {
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-family: 'IBM Plex Mono', monospace;
      font-weight: 600;
      font-size: 0.6rem;
    }

    .status-badge.success {
      background: rgba(0, 168, 107, 0.2);
      color: var(--success-green-light);
    }

    .status-badge.error {
      background: rgba(248, 81, 73, 0.2);
      color: var(--error-red);
    }

    .status-badge.warning {
      background: rgba(255, 107, 53, 0.2);
      color: var(--accent-orange);
    }

    .response-body {
      flex: 1;
      overflow-y: auto;
      padding: 0.875rem;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.8rem;
      line-height: 1.5;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    .response-body.editor-mode {
      padding: 0;
      overflow: hidden;
    }

    .response-body.response-mode {
      padding: 0;
      overflow: hidden;
    }

    .response-body .action-bar {
      flex-shrink: 0;
      padding: 0.5rem 0.875rem;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
    }

    .response-body pre {
      white-space: pre-wrap;
      word-break: break-word;
      margin: 0;
    }

    .response-body pre#jsonContent {
      flex: 1;
      overflow: auto;
      padding: 1rem;
      min-height: 0;
      background: var(--bg-primary);
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.75rem;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .response-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 200px;
      color: var(--text-muted);
      text-align: center;
    }

    .response-placeholder svg {
      width: 40px;
      height: 40px;
      margin-bottom: 0.75rem;
      opacity: 0.5;
    }

    /* JSON Syntax Highlighting */
    .json-key { color: var(--json-key); }
    .json-string { color: var(--json-string); }
    .json-number { color: var(--json-number); }
    .json-boolean { color: var(--json-boolean); }
    .json-null { color: var(--json-null); }

    /* Navigation */
    .navigation {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-top: 1px solid var(--border-color);
      flex-shrink: 0;
    }

    .nav-btn {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.5rem 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: 'DM Sans', sans-serif;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .nav-btn:hover:not(:disabled) {
      background: var(--bg-tertiary);
      border-color: var(--border-highlight);
    }

    .nav-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .nav-btn svg {
      width: 14px;
      height: 14px;
    }

    .nav-btn.next {
      background: var(--hl7-blue);
      border-color: var(--hl7-blue);
      color: white;
    }

    .nav-btn.next:hover:not(:disabled) {
      background: var(--hl7-blue-light);
      border-color: var(--hl7-blue-light);
    }

    .nav-info {
      text-align: center;
    }

    .nav-info-title {
      font-size: 0.65rem;
      color: var(--text-muted);
      margin-bottom: 0.15rem;
    }

    .nav-info-step {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    /* View JSON toggle */
    /* Action bar with tabs and execute button */
    .action-bar {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-shrink: 0;
    }

    .view-toggle {
      display: flex;
      gap: 0.25rem;
      flex-shrink: 0;
    }

    .view-toggle-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.3rem;
      padding: 0.4rem 0.65rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-secondary);
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.65rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .view-toggle-btn:hover {
      background: var(--bg-secondary);
    }

    .view-toggle-btn.active {
      background: var(--hl7-blue);
      border-color: var(--hl7-blue);
      color: white;
    }

    .view-toggle-btn svg {
      width: 11px;
      height: 11px;
    }

    .get-request-label {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.4rem 0.75rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-muted);
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.7rem;
    }

    .get-request-label svg {
      width: 12px;
      height: 12px;
    }

    /* Execute button in action bar */
    .execute-btn-inline {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      padding: 0.4rem 1rem;
      background: var(--hl7-blue);
      border: 1px solid var(--hl7-blue);
      border-radius: 6px;
      color: white;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-left: auto;
    }

    .execute-btn-inline:hover {
      background: var(--hl7-blue-light);
      border-color: var(--hl7-blue-light);
    }

    .execute-btn-inline:active {
      transform: scale(0.98);
    }

    .execute-btn-inline.loading {
      background: var(--text-muted);
      border-color: var(--text-muted);
      cursor: wait;
    }

    .execute-btn-inline.success {
      background: var(--success-green);
      border-color: var(--success-green);
    }

    .execute-btn-inline.error {
      background: var(--error-red);
      border-color: var(--error-red);
    }

    .execute-btn-inline svg {
      width: 14px;
      height: 14px;
    }

    .execute-btn-inline.loading svg {
      animation: spin 1s linear infinite;
    }

    /* Footer */
    footer {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      padding: 0.35rem 0;
      border-top: 1px solid var(--border-color);
      flex-shrink: 0;
    }

    .footer-logo {
      height: 18px;
      opacity: 0.6;
    }

    .footer-text {
      font-size: 0.65rem;
      color: var(--text-muted);
    }

    /* Animations */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .step-card {
      animation: fadeIn 0.3s ease-out;
    }

    /* Copy button */
    .copy-btn {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.4rem 0.75rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-secondary);
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.7rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .copy-btn:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .copy-btn.copied {
      background: rgba(0, 168, 107, 0.2);
      border-color: var(--success-green);
      color: var(--success-green);
    }

    .copy-btn svg {
      width: 12px;
      height: 12px;
    }

    /* ==================== VIEW MANAGEMENT ==================== */
    .view {
      display: none;
      height: 100%;
    }

    .view.active {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ==================== HOME VIEW ==================== */
    .home-view {
      justify-content: center;
      align-items: center;
      flex: 1;
      padding: 2rem;
    }

    .home-content {
      text-align: center;
      max-width: 900px;
    }

    .home-logo {
      width: 80px;
      height: 80px;
      margin-bottom: 1.5rem;
    }

    .home-title {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, var(--hl7-blue) 0%, var(--hl7-blue-light) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .home-subtitle {
      font-size: 1.1rem;
      color: var(--text-secondary);
      margin-bottom: 3rem;
    }

    .home-cards {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 2rem;
      margin-bottom: 2rem;
    }

    @media (max-width: 700px) {
      .home-cards {
        grid-template-columns: 1fr;
      }
    }

    .home-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 2rem;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .home-card:hover {
      transform: translateY(-4px);
      border-color: var(--hl7-blue);
      box-shadow: 0 12px 40px rgba(0, 102, 161, 0.2);
    }

    .home-card-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 1.5rem;
      padding: 1rem;
      background: linear-gradient(135deg, var(--hl7-blue) 0%, #004d7a 100%);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .home-card-icon svg {
      width: 32px;
      height: 32px;
      color: white;
    }

    .home-card-icon.green {
      background: linear-gradient(135deg, var(--success-green) 0%, #007a4d 100%);
    }

    .home-card-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .home-card-description {
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    /* ==================== LIVE TEST VIEW ==================== */
    .live-test-view {
      flex: 1;
      min-height: 0;
    }

    .live-test-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 0.75rem;
      flex-shrink: 0;
    }

    .live-test-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .live-test-title h2 {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .back-btn:hover {
      background: var(--bg-tertiary);
      border-color: var(--border-highlight);
    }

    .back-btn svg {
      width: 16px;
      height: 16px;
    }

    .live-test-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    @media (max-width: 900px) {
      .live-test-content {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr 1fr;
      }
    }

    .live-panel {
      display: flex;
      flex-direction: column;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
      min-height: 0;
    }

    .live-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.6rem 1rem;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
    }

    .live-panel-title {
      font-size: 0.85rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .live-panel-title svg {
      width: 16px;
      height: 16px;
      color: var(--hl7-blue-light);
    }

    .live-panel-body {
      flex: 1;
      min-height: 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .json-editor-container {
      position: relative;
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    .json-highlight {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 1rem;
      margin: 0;
      background: var(--bg-primary);
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.8rem;
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow: auto;
      pointer-events: none;
      color: var(--text-primary);
    }

    .json-input {
      position: relative;
      flex: 1;
      width: 100%;
      padding: 1rem;
      background: transparent;
      border: none;
      color: transparent;
      caret-color: var(--text-primary);
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.8rem;
      line-height: 1.5;
      resize: none;
      outline: none;
      z-index: 1;
      overflow: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .json-input::placeholder {
      color: var(--text-muted);
    }

    .json-input:placeholder-shown + .json-highlight,
    .json-editor-container:has(.json-input:placeholder-shown) .json-highlight {
      color: transparent;
    }

    /* Line Numbers Gutter */
    .json-gutter {
      position: absolute;
      top: 0;
      left: 0;
      width: 3rem;
      padding: 1rem 0.5rem 1rem 0;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-color);
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.8rem;
      line-height: 1.5;
      text-align: right;
      color: var(--text-muted);
      user-select: none;
      overflow: hidden;
      z-index: 2;
      box-sizing: border-box;
    }

    .json-gutter-line {
      display: block;
      padding-right: 0.5rem;
    }

    /* Adjust editor padding for gutter */
    .json-editor-container.with-gutter .json-input,
    .json-editor-container.with-gutter .json-highlight {
      padding-left: 3.5rem;
    }

    .expression-input-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-color);
      flex-shrink: 0;
    }

    .expression-input {
      flex: 1;
      padding: 0.6rem 0.75rem;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.85rem;
      outline: none;
      transition: border-color 0.2s ease;
      resize: none;
      overflow-y: hidden;
      min-height: 2.2rem;
      max-height: 8rem;
      line-height: 1.4;
    }

    .expression-input:focus {
      border-color: var(--hl7-blue);
    }

    .expression-input::placeholder {
      color: var(--text-muted);
    }

    .result-panel {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.8rem;
      line-height: 1.5;
    }

    .result-panel pre {
      white-space: pre-wrap;
      word-break: break-word;
      margin: 0;
    }

    .result-error {
      color: var(--error-red);
      padding: 1rem;
      background: rgba(248, 81, 73, 0.1);
      border-radius: 6px;
      font-size: 0.85rem;
    }

    .result-empty {
      color: var(--text-muted);
      text-align: center;
      padding: 2rem;
    }

    .example-expressions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-color);
      flex-shrink: 0;
    }

    .example-expressions-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      width: 100%;
      margin-bottom: 0.25rem;
    }

    .example-btn {
      padding: 0.35rem 0.6rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-secondary);
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.7rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .example-btn:hover {
      background: var(--hl7-blue);
      border-color: var(--hl7-blue);
      color: white;
    }

    /* Header home button */
    .home-btn {
      display: none;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .home-btn:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .home-btn svg {
      width: 16px;
      height: 16px;
    }

    .home-btn.visible {
      display: flex;
    }

    /* Resource Drawer */
    .drawer-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .drawer-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    .resource-drawer {
      position: fixed;
      top: 0;
      right: -380px;
      width: 380px;
      height: 100%;
      background: var(--bg-card);
      border-left: 1px solid var(--border-color);
      box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
      transition: right 0.3s ease;
      z-index: 1001;
      display: flex;
      flex-direction: column;
    }

    .resource-drawer.open {
      right: 0;
    }

    .drawer-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-secondary);
    }

    .drawer-header h3 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .drawer-close {
      background: none;
      border: none;
      padding: 0.5rem;
      cursor: pointer;
      color: var(--text-muted);
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .drawer-close:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .drawer-close svg {
      width: 18px;
      height: 18px;
    }

    .drawer-content {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .resource-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .resource-item {
      padding: 1rem;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .resource-item:hover {
      border-color: var(--hl7-blue);
      background: var(--bg-secondary);
    }

    .resource-item-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .resource-item-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .resource-item-icon svg {
      width: 20px;
      height: 20px;
    }

    .resource-item-icon.patient { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .resource-item-icon.observation { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
    .resource-item-icon.condition { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
    .resource-item-icon.medication { background: rgba(168, 85, 247, 0.15); color: #a855f7; }
    .resource-item-icon.bundle { background: rgba(251, 146, 60, 0.15); color: #fb923c; }
    .resource-item-icon.practitioner { background: rgba(20, 184, 166, 0.15); color: #14b8a6; }

    .resource-item-title {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text-primary);
    }

    .resource-item-type {
      font-size: 0.7rem;
      color: var(--text-muted);
      font-family: 'IBM Plex Mono', monospace;
    }

    .resource-item-description {
      font-size: 0.8rem;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    /* Workshop JSON Editor */
    #workshopEditorContainer {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    .workshop-json-editor {
      position: relative;
      flex: 1;
      display: flex;
      overflow: hidden;
      min-height: 0;
    }

    .workshop-json-highlight {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 1rem;
      margin: 0;
      background: transparent;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.75rem;
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow: auto;
      pointer-events: none;
      color: var(--text-primary);
    }

    .workshop-json-input {
      position: relative;
      flex: 1;
      width: 100%;
      padding: 1rem;
      background: transparent;
      border: none;
      color: transparent;
      caret-color: var(--text-primary);
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.75rem;
      line-height: 1.5;
      resize: none;
      outline: none;
      z-index: 1;
      overflow: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .workshop-json-input:focus + .workshop-json-highlight {
      background: rgba(0, 102, 161, 0.03);
    }

    /* Workshop Line Numbers Gutter */
    .workshop-json-gutter {
      position: absolute;
      top: 0;
      left: 0;
      width: 2.5rem;
      padding: 1rem 0.25rem 1rem 0;
      background: var(--bg-tertiary);
      border-right: 1px solid var(--border-color);
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.75rem;
      line-height: 1.5;
      text-align: right;
      color: var(--text-muted);
      user-select: none;
      overflow: hidden;
      z-index: 2;
      box-sizing: border-box;
    }

    .workshop-json-gutter .json-gutter-line {
      padding-right: 0.35rem;
    }

    .workshop-json-editor.with-gutter .workshop-json-input,
    .workshop-json-editor.with-gutter .workshop-json-highlight {
      padding-left: 3rem;
    }

    .workshop-editor-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 0.75rem;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
    }

    .workshop-editor-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .workshop-editor-label svg {
      width: 14px;
      height: 14px;
      stroke: var(--hl7-blue);
    }

    .workshop-editor-actions {
      display: flex;
      gap: 0.5rem;
    }

    .editor-action-btn {
      padding: 0.3rem 0.6rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-secondary);
      font-size: 0.7rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .editor-action-btn:hover {
      background: var(--bg-card);
      color: var(--text-primary);
      border-color: var(--hl7-blue);
    }

    .editor-action-btn svg {
      width: 12px;
      height: 12px;
    }

    .editor-action-btn.reset {
      color: var(--accent-orange);
    }

    .editor-action-btn.reset:hover {
      border-color: var(--accent-orange);
      background: rgba(255, 107, 53, 0.1);
    }
  </style>
  <!-- FHIRPath.js library (browser build from official release) -->
  <script src="lib/fhirpath.min.js" charset="UTF-8"></script>
  <script src="lib/fhirpath.r4.min.js" charset="UTF-8"></script>
</head>
<body>
  <div class="bg-grid"></div>

  <div class="container">
    <header>
      <div class="header-left">
        <img src="logo-ceg-icon.svg" alt="CEG Consultores" class="logo-ceg" style="cursor: pointer;" onclick="showView('home')">
        <span class="header-title" style="cursor: pointer;" onclick="showView('home')">Taller FHIRPath</span>
      </div>
      <div class="header-right">
        <button class="home-btn" id="homeBtn" onclick="showView('home')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
          </svg>
          Inicio
        </button>
        <div class="server-status" id="serverStatus">
          <span class="dot"></span>
          <span id="serverStatusText">Verificando...</span>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()" title="Cambiar tema">
          <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
          </svg>
          <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
          </svg>
        </button>
      </div>
    </header>

    <!-- ==================== HOME VIEW ==================== -->
    <div id="homeView" class="view home-view active">
      <div class="home-content">
        <img src="logo-ceg-icon.svg" alt="CEG Consultores" class="home-logo">
        <h1 class="home-title">Taller FHIRPath</h1>
        <p class="home-subtitle">Conectaton HL7 Chile 2025</p>

        <div class="home-cards">
          <div class="home-card" onclick="showView('workshop')">
            <div class="home-card-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
              </svg>
            </div>
            <h3 class="home-card-title">Ejercicios del Taller</h3>
            <p class="home-card-description">Aprende FHIRPath paso a paso con ejercicios practicos de validacion y busqueda usando HAPI FHIR</p>
          </div>

          <div class="home-card" onclick="showView('livetest')">
            <div class="home-card-icon green">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/>
              </svg>
            </div>
            <h3 class="home-card-title">Live Test</h3>
            <p class="home-card-description">Prueba expresiones FHIRPath en tiempo real sobre cualquier recurso FHIR</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== WORKSHOP VIEW (STEPPER) ==================== -->
    <div id="workshopView" class="view">
      <!-- Progress bar -->
      <div class="progress-container">
        <div class="progress-header">
          <span class="progress-title">Conectaton HL7 Chile 2025</span>
          <span class="progress-counter" id="progressCounter">Paso 1 de 10</span>
        </div>
        <div class="progress-bar" id="progressBar">
          <!-- Steps will be rendered here -->
        </div>
      </div>

      <!-- Main content -->
      <div class="main-content">
        <div class="step-card" id="stepCard">
          <!-- Step content will be rendered here -->
        </div>
      </div>

      <!-- Navigation -->
      <nav class="navigation">
        <button class="nav-btn prev" id="prevBtn" onclick="prevStep()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Anterior
        </button>
        <div class="nav-info">
          <div class="nav-info-title">Siguiente paso</div>
          <div class="nav-info-step" id="nextStepPreview">--</div>
        </div>
        <button class="nav-btn next" id="nextBtn" onclick="nextStep()">
          Siguiente
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 12h14M12 5l7 7-7 7"/>
          </svg>
        </button>
      </nav>
    </div>

    <!-- ==================== LIVE TEST VIEW ==================== -->
    <div id="livetestView" class="view live-test-view">
      <div class="live-test-header">
        <div class="live-test-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; color: var(--success-green);">
            <polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/>
          </svg>
          <h2>FHIRPath Live Test</h2>
        </div>
      </div>

      <div class="live-test-content">
        <!-- Input Panel -->
        <div class="live-panel">
          <div class="live-panel-header">
            <span class="live-panel-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
              </svg>
              Recurso FHIR (JSON)
            </span>
            <div style="display: flex; gap: 8px;">
              <button class="copy-btn" onclick="formatJsonInput()" title="Formatear JSON">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/>
                </svg>
                Formatear
              </button>
              <button class="copy-btn" onclick="toggleResourceDrawer()" title="Cargar recurso de ejemplo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                  <polyline points="14 2 14 8 20 8"/>
                  <line x1="12" y1="18" x2="12" y2="12"/>
                  <line x1="9" y1="15" x2="15" y2="15"/>
                </svg>
                Recursos
              </button>
            </div>
          </div>
          <div class="live-panel-body">
            <div class="json-editor-container with-gutter">
              <div id="jsonGutter" class="json-gutter"></div>
              <textarea id="jsonInput" class="json-input" placeholder="Pega aqui tu recurso FHIR en formato JSON..." spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off" oninput="updateJsonHighlight()" onscroll="syncScroll()"></textarea>
              <pre id="jsonHighlight" class="json-highlight" aria-hidden="true"></pre>
            </div>
          </div>
        </div>

        <!-- Output Panel -->
        <div class="live-panel">
          <div class="live-panel-header">
            <span class="live-panel-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/>
              </svg>
              Resultado
            </span>
          </div>
          <div class="live-panel-body">
            <div class="expression-input-container">
              <textarea id="expressionInput" class="expression-input" placeholder="Escribe una expresion FHIRPath..." oninput="evaluateExpression(); autoResizeExpression(this);" rows="1" spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off"></textarea>
            </div>
            <div class="example-expressions">
              <span class="example-expressions-label">Ejemplos:</span>
              <button class="example-btn" onclick="setExpression('name.given')">name.given</button>
              <button class="example-btn" onclick="setExpression('identifier.value')">identifier.value</button>
              <button class="example-btn" onclick="setExpression(&quot;telecom.where(system='phone')&quot;)">telecom.where()</button>
              <button class="example-btn" onclick="setExpression('birthDate.exists()')">birthDate.exists()</button>
              <button class="example-btn" onclick="setExpression(&quot;name.family.startsWith('G')&quot;)">startsWith()</button>
              <button class="example-btn" onclick="setExpression(&quot;identifier.where(system='http://regcivil.cl/run').value&quot;)">RUT</button>
            </div>
            <div id="resultPanel" class="result-panel">
              <div class="result-empty">
                <p>Escribe una expresion FHIRPath para ver el resultado</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <img src="logo-ceg-icon.svg" alt="CEG" class="footer-logo">
      <span class="footer-text">CEG Consultores SpA | Conectaton HL7 Chile 2025</span>
    </footer>

    <!-- Resource Drawer -->
    <div id="resourceDrawerOverlay" class="drawer-overlay" onclick="toggleResourceDrawer()"></div>
    <div id="resourceDrawer" class="resource-drawer">
      <div class="drawer-header">
        <h3>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
          </svg>
          Recursos de Ejemplo
        </h3>
        <button class="drawer-close" onclick="toggleResourceDrawer()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="drawer-content">
        <div class="resource-list" id="resourceList">
          <!-- Resources will be populated by JavaScript -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== CONFIGURATION ====================
    const FHIR_BASE = 'http://localhost:8081/fhir';
    let currentStep = 0;
    let stepStates = {}; // Track execution state of each step
    let editedResources = {}; // Store edited JSON for each step

    // ==================== STEP DATA ====================
    const STEPS = [
      {
        id: 'loadProfileV1',
        number: 1,
        title: 'Cargar Perfil v1 (Permisivo)',
        category: 'invariantes',
        categoryLabel: 'Invariantes',
        method: 'POST',
        endpoint: '/StructureDefinition',
        description: 'Cargamos un StructureDefinition con 3 invariantes FHIRPath. Con <code>severity: warning</code> solo generan advertencias.',
        highlights: [
          { type: 'info', text: '<strong>cl-rut-formato:</strong> <code>identifier.where(system=\'http://regcivil.cl/run\').all(value.matches(\'^[0-9]+-[0-9Kk]$\'))</code>' },
          { type: 'note', text: '<strong>where()</strong> filtra identificadores por system. <strong>all()</strong> verifica que TODOS cumplan. <strong>matches()</strong> valida con regex.' },
          { type: 'info', text: '<strong>cl-contacto-emergencia:</strong> <code>contact.exists()</code>' },
          { type: 'note', text: '<strong>exists()</strong> retorna true si hay al menos un elemento en la coleccion.' },
          { type: 'info', text: '<strong>cl-telefono-movil:</strong> <code>telecom.where(system=\'phone\' and use=\'mobile\').all(value.startsWith(\'+56\'))</code>' },
          { type: 'note', text: '<strong>startsWith()</strong> verifica que el string comience con el prefijo indicado (+56).' }
        ],
        resource: 'structureDefinitionV1'
      },
      {
        id: 'validateJuan1',
        number: 2,
        title: 'Validar Juan Gonzalez (v1)',
        category: 'invariantes',
        categoryLabel: 'Invariantes',
        method: 'POST',
        endpoint: '/Patient/$validate',
        description: 'Validamos a Juan contra el perfil v1. Analicemos como evalua cada expresion FHIRPath:',
        highlights: [
          { type: 'success', text: '<strong>cl-rut-formato:</strong> <code>\'12345678-9\'.matches(\'^[0-9]+-[0-9Kk]$\')</code> → <strong>true</strong>' },
          { type: 'success', text: '<strong>cl-telefono-movil:</strong> <code>\'+56912345678\'.startsWith(\'+56\')</code> → <strong>true</strong>' },
          { type: 'warning', text: '<strong>cl-contacto-emergencia:</strong> <code>contact.exists()</code> → <strong>false</strong> (no tiene contacto)' }
        ],
        resource: 'patientJuanV1'
      },
      {
        id: 'validateMaria1',
        number: 3,
        title: 'Validar Maria Silva (v1)',
        category: 'invariantes',
        categoryLabel: 'Invariantes',
        method: 'POST',
        endpoint: '/Patient/$validate',
        description: 'Maria tiene problemas con los 3 constraints del perfil v1. Veamos como fallan:',
        highlights: [
          { type: 'warning', text: '<strong>cl-rut-formato:</strong> <code>\'123-4\'.matches(\'^[0-9]+-[0-9Kk]$\')</code> → true (formato OK, pero muy corto)' },
          { type: 'warning', text: '<strong>cl-telefono-movil:</strong> <code>telecom.where(...).empty()</code> → true (no tiene movil)' },
          { type: 'warning', text: '<strong>cl-contacto-emergencia:</strong> <code>contact.exists()</code> → <strong>false</strong> (no tiene contacto)' },
          { type: 'info', text: 'Como son <code>severity: warning</code>, la validacion pasa con advertencias' }
        ],
        resource: 'patientMariaV1'
      },
      {
        id: 'loadProfileV2',
        number: 4,
        title: 'Cargar Perfil v2 (Estricto)',
        category: 'invariantes',
        categoryLabel: 'Cambio de Perfil',
        method: 'POST',
        endpoint: '/StructureDefinition',
        description: 'Cargamos el perfil v2 con <code>severity: error</code> y expresiones mas estrictas:',
        highlights: [
          { type: 'warning', text: '<strong>cl-rut-formato:</strong> <code>identifier.where(...).all(value.matches(\'^[0-9]{7,8}-[0-9Kk]$\'))</code>' },
          { type: 'note', text: 'Ahora exige 7-8 digitos con <code>{7,8}</code> en la regex. RUT "123-4" ya no pasa.' },
          { type: 'warning', text: '<strong>cl-contacto-emergencia:</strong> <code>today().toString().substring(0,4).toInteger() - birthDate...</code>' },
          { type: 'note', text: '<strong>today()</strong> fecha actual. <strong>substring(0,4)</strong> extrae los primeros 4 caracteres (año). <strong>toInteger()</strong> convierte string a numero para calcular la edad.' },
          { type: 'warning', text: '<strong>cl-telefono-movil:</strong> <code>telecom.where(...).exists() and ...all(value.startsWith(\'+56\'))</code>' },
          { type: 'note', text: 'Cambio clave: <strong>exists()</strong> exige que DEBE haber telefono movil, a diferencia de v1 donde era opcional.' }
        ],
        resource: 'structureDefinitionV2'
      },
      {
        id: 'validateJuan2',
        number: 5,
        title: 'Validar Juan Gonzalez (v2)',
        category: 'invariantes',
        categoryLabel: 'Con Perfil v2',
        method: 'POST',
        endpoint: '/Patient/$validate',
        description: 'Juan sigue pasando con el perfil v2 estricto porque cumple todas las expresiones:',
        highlights: [
          { type: 'success', text: '<strong>cl-rut-formato:</strong> <code>\'12345678-9\'.matches(\'^[0-9]{7,8}-[0-9Kk]$\')</code> → <strong>true</strong> (8 digitos)' },
          { type: 'success', text: '<strong>cl-telefono-movil:</strong> <code>telecom.where(...).exists()</code> → <strong>true</strong> (tiene movil)' },
          { type: 'success', text: '<strong>cl-contacto-emergencia:</strong> Edad 34 < 65 → no requiere contacto' }
        ],
        resource: 'patientJuanV2'
      },
      {
        id: 'validateMaria2',
        number: 6,
        title: 'Validar Maria Silva (v2 - FALLA)',
        category: 'invariantes',
        categoryLabel: 'Con Perfil v2',
        method: 'POST',
        endpoint: '/Patient/$validate',
        description: 'Maria FALLA la validacion con el perfil v2. Veamos por que:',
        highlights: [
          { type: 'warning', text: '<strong>cl-rut-formato:</strong> <code>\'123-4\'.matches(\'^[0-9]{7,8}-...$\')</code> → <strong>false</strong> (solo 3 digitos)' },
          { type: 'warning', text: '<strong>cl-telefono-movil:</strong> <code>telecom.where(...).exists()</code> → <strong>false</strong> (no tiene movil)' },
          { type: 'warning', text: '<strong>cl-contacto-emergencia:</strong> Edad 69 >= 65 y <code>contact.exists()</code> → <strong>false</strong>' },
          { type: 'info', text: 'Con <code>severity: error</code>, cualquier false bloquea la validacion' }
        ],
        resource: 'patientMariaV2'
      },
      {
        id: 'createPatients',
        number: 7,
        title: 'Crear Pacientes de Prueba',
        category: 'searchparam',
        categoryLabel: 'SearchParameters',
        method: 'POST',
        endpoint: '/Patient (x3)',
        description: 'Creamos 3 pacientes con la extension "extranjero" para probar las busquedas por extension:',
        highlights: [
          { type: 'info', text: 'Juan Gonzalez: <code>extranjero = false</code>' },
          { type: 'success', text: 'Maria Silva: <code>extranjero = true</code>' },
          { type: 'info', text: 'Pedro Lagos: <code>extranjero = false</code>' }
        ],
        resource: 'patients'
      },
      {
        id: 'searchWithoutSP',
        number: 8,
        title: 'Buscar Extranjeros (sin SearchParameter)',
        category: 'searchparam',
        categoryLabel: 'SearchParameters',
        method: 'GET',
        endpoint: '/Patient?extranjero=true',
        description: 'Sin un SearchParameter, el servidor no sabe como interpretar el parametro "extranjero":',
        highlights: [
          { type: 'warning', text: '<strong>Problema:</strong> No existe una expresion FHIRPath asociada a "extranjero"' },
          { type: 'warning', text: 'El servidor no puede navegar a <code>Patient.extension.where(...)</code>' },
          { type: 'info', text: 'Resultado: Ignora el parametro o retorna error 400' },
          { type: 'info', text: '<strong>Solucion:</strong> Crear un SearchParameter con la expresion FHIRPath' }
        ],
        resource: null
      },
      {
        id: 'loadSearchParam',
        number: 9,
        title: 'Cargar SearchParameter Extranjero',
        category: 'searchparam',
        categoryLabel: 'SearchParameters',
        method: 'POST',
        endpoint: '/SearchParameter',
        description: 'Registramos un SearchParameter que usa FHIRPath para buscar por la extension "extranjero":',
        highlights: [
          { type: 'success', text: '<strong>Expression:</strong> <code>Patient.extension.where(url=\'...extranjero\').value</code>' },
          { type: 'note', text: '<strong>Patient.extension</strong> navega a las extensiones. <strong>where()</strong> filtra por URL de la extension. <strong>.value</strong> extrae el valor booleano.' }
        ],
        resource: 'searchParameter'
      },
      {
        id: 'reindexPatients',
        number: 10,
        title: 'Reindexar Pacientes',
        category: 'searchparam',
        categoryLabel: 'SearchParameters',
        method: 'POST',
        endpoint: '/$reindex',
        description: 'Los pacientes fueron creados ANTES del SearchParameter, por lo que no estan indexados. Ejecutamos un reindex:',
        highlights: [
          { type: 'warning', text: '<strong>Problema:</strong> Los pacientes existentes no tienen el indice "extranjero"' },
          { type: 'info', text: 'El servidor debe recorrer los recursos y aplicar la expresion FHIRPath' },
          { type: 'success', text: '<strong>$reindex</strong> fuerza al servidor a reindexar todos los recursos' }
        ],
        resource: 'reindexParameters'
      },
      {
        id: 'searchWithSP',
        number: 11,
        title: 'Buscar Extranjeros (con SearchParameter)',
        category: 'searchparam',
        categoryLabel: 'SearchParameters',
        method: 'GET',
        endpoint: '/Patient?extranjero=true',
        description: 'Con el SearchParameter registrado y los pacientes reindexados, la busqueda funciona:',
        highlights: [
          { type: 'success', text: '<strong>Proceso:</strong> GET /Patient?extranjero=true' },
          { type: 'info', text: '1. El servidor busca en su indice de <code>extranjero</code>' },
          { type: 'info', text: '2. Encuentra pacientes donde la extension tiene <code>valueBoolean = true</code>' },
          { type: 'success', text: '3. Retorna un Bundle con Maria Silva (extranjera)' }
        ],
        resource: null
      }
    ];

    // ==================== RESOURCES ====================
    const RESOURCES = {
      structureDefinitionV1: {
        "resourceType": "StructureDefinition",
        "url": "https://example.org/fhir/StructureDefinition/PacienteChilenoDemo",
        "version": "1.0.0",
        "name": "PacienteChilenoDemo",
        "title": "Paciente Chileno Demo - v1 (Permisivo)",
        "status": "active",
        "experimental": true,
        "date": "2025-01-12",
        "publisher": "Taller FHIRPath - Conectaton HL7 Chile",
        "description": "Perfil de demostración para el taller de FHIRPath. Version 1 con constraints permisivos.",
        "fhirVersion": "4.0.1",
        "kind": "resource",
        "abstract": false,
        "type": "Patient",
        "baseDefinition": "http://hl7.org/fhir/StructureDefinition/Patient",
        "derivation": "constraint",
        "differential": {
          "element": [
            {
              "id": "Patient",
              "path": "Patient",
              "constraint": [
                {
                  "key": "cl-rut-formato",
                  "severity": "warning",
                  "human": "El RUT debe tener formato valido (digitos-digito verificador)",
                  "expression": "identifier.where(system='http://regcivil.cl/run').all(value.matches('^[0-9]+-[0-9Kk]$'))",
                  "source": "https://example.org/fhir/StructureDefinition/PacienteChilenoDemo"
                },
                {
                  "key": "cl-contacto-emergencia",
                  "severity": "warning",
                  "human": "Se recomienda tener un contacto de emergencia",
                  "expression": "contact.exists()",
                  "source": "https://example.org/fhir/StructureDefinition/PacienteChilenoDemo"
                },
                {
                  "key": "cl-telefono-movil",
                  "severity": "warning",
                  "human": "Si existe telefono movil, debe tener formato chileno (+56)",
                  "expression": "telecom.where(system='phone' and use='mobile').all(value.startsWith('+56'))",
                  "source": "https://example.org/fhir/StructureDefinition/PacienteChilenoDemo"
                }
              ]
            },
            {
              "id": "Patient.identifier",
              "path": "Patient.identifier",
              "min": 1,
              "mustSupport": true
            },
            {
              "id": "Patient.name",
              "path": "Patient.name",
              "min": 1,
              "mustSupport": true
            }
          ]
        }
      },
      structureDefinitionV2: {
        "resourceType": "StructureDefinition",
        "url": "https://example.org/fhir/StructureDefinition/PacienteChilenoDemo",
        "version": "2.0.0",
        "name": "PacienteChilenoDemo",
        "title": "Paciente Chileno Demo - v2 (Estricto)",
        "status": "active",
        "experimental": true,
        "date": "2025-01-12",
        "publisher": "Taller FHIRPath - Conectaton HL7 Chile",
        "description": "Perfil de demostración - Version 2 con constraints ESTRICTOS.",
        "fhirVersion": "4.0.1",
        "kind": "resource",
        "abstract": false,
        "type": "Patient",
        "baseDefinition": "http://hl7.org/fhir/StructureDefinition/Patient",
        "derivation": "constraint",
        "differential": {
          "element": [
            {
              "id": "Patient",
              "path": "Patient",
              "constraint": [
                {
                  "key": "cl-rut-formato",
                  "severity": "error",
                  "human": "El RUT DEBE tener formato valido con 7-8 digitos (ej: 12345678-9)",
                  "expression": "identifier.where(system='http://regcivil.cl/run').all(value.matches('^[0-9]{7,8}-[0-9Kk]$'))",
                  "source": "https://example.org/fhir/StructureDefinition/PacienteChilenoDemo"
                },
                {
                  "key": "cl-contacto-emergencia",
                  "severity": "error",
                  "human": "Pacientes mayores de 65 anios DEBEN tener un contacto de emergencia",
                  "expression": "birthDate.empty() or (today().toString().substring(0,4).toInteger() - birthDate.toString().substring(0,4).toInteger() < 65) or contact.exists()",
                  "source": "https://example.org/fhir/StructureDefinition/PacienteChilenoDemo"
                },
                {
                  "key": "cl-telefono-movil",
                  "severity": "error",
                  "human": "El paciente DEBE tener un telefono movil con formato chileno (+56)",
                  "expression": "telecom.where(system='phone' and use='mobile').exists() and telecom.where(system='phone' and use='mobile').all(value.startsWith('+56'))",
                  "source": "https://example.org/fhir/StructureDefinition/PacienteChilenoDemo"
                }
              ]
            },
            {
              "id": "Patient.identifier",
              "path": "Patient.identifier",
              "min": 1,
              "mustSupport": true
            },
            {
              "id": "Patient.name",
              "path": "Patient.name",
              "min": 1,
              "mustSupport": true
            },
            {
              "id": "Patient.telecom",
              "path": "Patient.telecom",
              "min": 1,
              "mustSupport": true
            }
          ]
        }
      },
      // Pacientes para validación con perfil v1
      patientJuanV1: {
        "resourceType": "Patient",
        "meta": {
          "profile": ["https://example.org/fhir/StructureDefinition/PacienteChilenoDemo|1.0.0"]
        },
        "extension": [{
          "url": "https://example.org/fhir/StructureDefinition/extranjero",
          "valueBoolean": false
        }],
        "identifier": [{
          "system": "http://regcivil.cl/run",
          "value": "12345678-9"
        }],
        "active": true,
        "name": [{
          "use": "official",
          "family": "Gonzalez",
          "given": ["Juan", "Carlos"]
        }],
        "telecom": [
          {"system": "phone", "value": "+56912345678", "use": "mobile"},
          {"system": "email", "value": "juan.gonzalez@example.com", "use": "home"}
        ],
        "gender": "male",
        "birthDate": "1990-05-15"
      },
      patientMariaV1: {
        "resourceType": "Patient",
        "meta": {
          "profile": ["https://example.org/fhir/StructureDefinition/PacienteChilenoDemo|1.0.0"]
        },
        "extension": [{
          "url": "https://example.org/fhir/StructureDefinition/extranjero",
          "valueBoolean": true
        }],
        "identifier": [{
          "system": "http://regcivil.cl/run",
          "value": "123-4"
        }],
        "active": true,
        "name": [{
          "use": "official",
          "family": "Silva",
          "given": ["Maria", "Elena"]
        }],
        "telecom": [
          {"system": "email", "value": "maria.silva@example.com", "use": "home"}
        ],
        "gender": "female",
        "birthDate": "1955-03-20"
      },
      // Pacientes para validación con perfil v2
      patientJuanV2: {
        "resourceType": "Patient",
        "meta": {
          "profile": ["https://example.org/fhir/StructureDefinition/PacienteChilenoDemo|2.0.0"]
        },
        "identifier": [{
          "system": "http://regcivil.cl/run",
          "value": "12345678-9"
        }],
        "active": true,
        "name": [{
          "use": "official",
          "family": "Gonzalez",
          "given": ["Juan", "Carlos"]
        }],
        "telecom": [
          {"system": "phone", "value": "+56912345678", "use": "mobile"},
          {"system": "email", "value": "juan.gonzalez@example.com", "use": "home"}
        ],
        "gender": "male",
        "birthDate": "1990-05-15"
      },
      patientMariaV2: {
        "resourceType": "Patient",
        "meta": {
          "profile": ["https://example.org/fhir/StructureDefinition/PacienteChilenoDemo|2.0.0"]
        },
        "identifier": [{
          "system": "http://regcivil.cl/run",
          "value": "123-4"
        }],
        "active": true,
        "name": [{
          "use": "official",
          "family": "Silva",
          "given": ["Maria", "Elena"]
        }],
        "telecom": [
          {"system": "email", "value": "maria.silva@example.com", "use": "home"}
        ],
        "gender": "female",
        "birthDate": "1955-03-20"
      },
      patientPedro: {
        "resourceType": "Patient",
        "meta": {
          "profile": ["https://example.org/fhir/StructureDefinition/PacienteChilenoDemo|1.0.0"]
        },
        "extension": [{
          "url": "https://example.org/fhir/StructureDefinition/extranjero",
          "valueBoolean": false
        }],
        "identifier": [{
          "system": "http://regcivil.cl/run",
          "value": "98765432-1"
        }],
        "active": true,
        "name": [{
          "use": "official",
          "family": "Lagos",
          "given": ["Pedro", "Antonio"]
        }],
        "telecom": [
          {"system": "phone", "value": "+56998765432", "use": "mobile"},
          {"system": "email", "value": "pedro.lagos@example.com", "use": "work"}
        ],
        "gender": "male",
        "birthDate": "1985-11-08",
        "contact": [{
          "relationship": [{"coding": [{"system": "http://terminology.hl7.org/CodeSystem/v2-0131", "code": "C"}]}],
          "name": {"family": "Lagos", "given": ["Ana"]},
          "telecom": [{"system": "phone", "value": "+56911111111", "use": "mobile"}]
        }]
      },
      searchParameter: {
        "resourceType": "SearchParameter",
        "id": "patient-extranjero",
        "url": "https://example.org/fhir/SearchParameter/patient-extranjero",
        "version": "1.0.0",
        "name": "PatientExtranjero",
        "status": "active",
        "experimental": true,
        "date": "2025-01-12",
        "publisher": "Taller FHIRPath - Conectaton HL7 Chile",
        "description": "SearchParameter para buscar pacientes segun si son extranjeros.",
        "code": "extranjero",
        "base": ["Patient"],
        "type": "token",
        "expression": "Patient.extension.where(url='https://example.org/fhir/StructureDefinition/extranjero').value"
      },
      reindexParameters: {
        "resourceType": "Parameters",
        "parameter": [{
          "name": "url",
          "valueString": "Patient"
        }]
      }
    };

    // ==================== UTILITY FUNCTIONS ====================
    function syntaxHighlight(json) {
      if (typeof json !== 'string') {
        json = JSON.stringify(json, null, 2);
      }
      json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
        let cls = 'json-number';
        if (/^"/.test(match)) {
          if (/:$/.test(match)) {
            cls = 'json-key';
          } else {
            cls = 'json-string';
          }
        } else if (/true|false/.test(match)) {
          cls = 'json-boolean';
        } else if (/null/.test(match)) {
          cls = 'json-null';
        }
        return '<span class="' + cls + '">' + match + '</span>';
      });
    }

    // ==================== JSON EDITOR LINE NUMBERS ====================
    function generateLineNumbers(text, gutterId) {
      const gutter = document.getElementById(gutterId);
      if (!gutter) return;

      const lines = text.split('\n');
      let html = '';

      for (let i = 1; i <= lines.length; i++) {
        html += `<span class="json-gutter-line">${i}</span>`;
      }

      gutter.innerHTML = html;
    }

    function getResourceForStep(step) {
      if (!step.resource) return null;
      if (step.resource === 'patients') {
        return [RESOURCES.patientJuanV1, RESOURCES.patientMariaV1, RESOURCES.patientPedro];
      }
      return RESOURCES[step.resource];
    }

    // ==================== WORKSHOP JSON EDITOR FUNCTIONS ====================
    function getEditedJsonText(step, resource) {
      // Return edited version if exists, otherwise original formatted JSON
      if (editedResources[step.id]) {
        return editedResources[step.id];
      }
      return JSON.stringify(resource, null, 2);
    }

    function getEditedResource() {
      const step = STEPS[currentStep];
      const input = document.getElementById('workshopJsonInput');
      if (!input) return getResourceForStep(step);

      try {
        return JSON.parse(input.value);
      } catch (e) {
        // If invalid JSON, return the original resource
        return getResourceForStep(step);
      }
    }

    function updateWorkshopJsonHighlight() {
      const input = document.getElementById('workshopJsonInput');
      const highlight = document.getElementById('workshopJsonHighlight');
      if (!input || !highlight) return;

      const step = STEPS[currentStep];
      const text = input.value;

      // Save the edited content
      editedResources[step.id] = text;

      try {
        // Validate JSON but highlight the raw text to preserve formatting
        JSON.parse(text);
        highlight.innerHTML = syntaxHighlight(text);
      } catch (e) {
        // If invalid JSON, show as plain text with error indication
        const escaped = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        highlight.innerHTML = '<span style="color: var(--error-red);">' + escaped + '</span>';
      }

      // Update line numbers
      generateLineNumbers(text, 'workshopJsonGutter');

      // Sync scroll after content update
      requestAnimationFrame(() => syncWorkshopScroll());
    }

    function syncWorkshopScroll() {
      const input = document.getElementById('workshopJsonInput');
      const highlight = document.getElementById('workshopJsonHighlight');
      const gutter = document.getElementById('workshopJsonGutter');
      if (!input || !highlight) return;

      highlight.scrollTop = input.scrollTop;
      highlight.scrollLeft = input.scrollLeft;
      if (gutter) {
        gutter.scrollTop = input.scrollTop;
      }
    }

    function formatWorkshopJson() {
      const input = document.getElementById('workshopJsonInput');
      if (!input) return;

      try {
        const parsed = JSON.parse(input.value);
        input.value = JSON.stringify(parsed, null, 2);
        updateWorkshopJsonHighlight();
      } catch (e) {
        // Show error feedback
        alert('JSON invalido: ' + e.message);
      }
    }

    function resetWorkshopJson() {
      const step = STEPS[currentStep];
      const resource = getResourceForStep(step);
      const input = document.getElementById('workshopJsonInput');
      if (!input || !resource) return;

      // Clear the edited version
      delete editedResources[step.id];

      // Reset to original
      input.value = JSON.stringify(resource, null, 2);
      updateWorkshopJsonHighlight();
    }

    // ==================== RENDER FUNCTIONS ====================
    function renderProgressBar() {
      const bar = document.getElementById('progressBar');
      bar.innerHTML = STEPS.map((step, index) => {
        let stateClass = '';
        if (index < currentStep) stateClass = stepStates[step.id] === 'error' ? 'error' : 'completed';
        else if (index === currentStep) stateClass = 'active';
        return `<div class="progress-segment ${stateClass}" onclick="goToStep(${index})" title="Paso ${step.number}: ${step.title}"></div>`;
      }).join('');

      document.getElementById('progressCounter').textContent = `Paso ${currentStep + 1} de ${STEPS.length}`;
    }

    function renderStep() {
      const step = STEPS[currentStep];
      const resource = getResourceForStep(step);
      const state = stepStates[step.id];

      let executeButtonClass = '';
      let executeButtonIcon = '<path d="M5 12h14M12 5l7 7-7 7"/>';
      let executeButtonText = 'Ejecutar';

      if (state === 'loading') {
        executeButtonClass = 'loading';
        executeButtonIcon = '<circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="30 70"/>';
        executeButtonText = 'Ejecutando...';
      } else if (state === 'success') {
        executeButtonClass = 'success';
        executeButtonIcon = '<polyline points="20 6 9 17 4 12"/>';
        executeButtonText = 'Completado';
      } else if (state === 'error') {
        executeButtonClass = 'error';
        executeButtonIcon = '<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>';
        executeButtonText = 'Error - Reintentar';
      }

      const categoryClass = step.category === 'searchparam' ? 'searchparam' : '';

      const stepCard = document.getElementById('stepCard');
      stepCard.innerHTML = `
        <div class="step-header">
          <div class="step-header-left">
            <div class="step-number-badge">${step.number}</div>
            <div class="step-title-group">
              <h2>${step.title}</h2>
              <div class="step-subtitle"><span class="method">${step.method}</span> ${step.endpoint}</div>
            </div>
          </div>
          <div class="step-category ${categoryClass}">${step.categoryLabel}</div>
        </div>
        <div class="step-content">
          <div class="info-panel">
            <div class="info-section">
              <div class="info-section-title">Descripcion</div>
              <p>${step.description}</p>
              ${step.highlights.map(h => `
                <div class="${h.type === 'note' ? 'info-note' : 'info-highlight ' + h.type}">${h.text}</div>
              `).join('')}
            </div>
          </div>
          <div class="response-panel">
            <div class="response-toolbar">
              <div class="response-toolbar-left">
                <span class="toolbar-dot"></span>
                <span class="toolbar-dot"></span>
                <span class="toolbar-dot"></span>
                <span class="response-endpoint" id="responseEndpoint">${FHIR_BASE}${step.endpoint}</span>
              </div>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span class="status-badge" id="statusBadge" style="display: none;"></span>
                <button class="copy-btn" id="copyBtn" style="display: none;" onclick="copyResponse()">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                  </svg>
                  <span id="copyBtnText">Copiar</span>
                </button>
              </div>
            </div>
            <div class="response-body" id="responseBody">
              <div class="action-bar">
                ${resource ? `
                  <div class="view-toggle">
                    <button class="view-toggle-btn active" onclick="showRequestResponse('request')">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                      </svg>
                      Request
                    </button>
                    <button class="view-toggle-btn" onclick="showRequestResponse('response')">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                      </svg>
                      Response
                    </button>
                  </div>
                ` : `
                  <div class="view-toggle">
                    <span class="get-request-label">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                      </svg>
                      GET Request (sin body)
                    </span>
                  </div>
                `}
                <button class="execute-btn-inline ${executeButtonClass}" onclick="executeCurrentStep()" ${state === 'loading' ? 'disabled' : ''}>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    ${executeButtonIcon}
                  </svg>
                  ${executeButtonText}
                </button>
              </div>
              ${resource ? `
                <div id="workshopEditorContainer">
                  <div class="workshop-editor-toolbar">
                    <div class="workshop-editor-label">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                      </svg>
                      <span>JSON Editable - Modifica antes de enviar</span>
                    </div>
                    <div class="workshop-editor-actions">
                      <button class="editor-action-btn" onclick="formatWorkshopJson()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <line x1="21" y1="10" x2="3" y2="10"/>
                          <line x1="21" y1="6" x2="3" y2="6"/>
                          <line x1="21" y1="14" x2="3" y2="14"/>
                          <line x1="21" y1="18" x2="3" y2="18"/>
                        </svg>
                        Formatear
                      </button>
                      <button class="editor-action-btn reset" onclick="resetWorkshopJson()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                          <path d="M3 3v5h5"/>
                        </svg>
                        Restaurar
                      </button>
                    </div>
                  </div>
                  <div class="workshop-json-editor with-gutter">
                    <div id="workshopJsonGutter" class="workshop-json-gutter"></div>
                    <textarea id="workshopJsonInput" class="workshop-json-input" spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off" oninput="updateWorkshopJsonHighlight()" onscroll="syncWorkshopScroll()">${getEditedJsonText(step, resource)}</textarea>
                    <pre id="workshopJsonHighlight" class="workshop-json-highlight" aria-hidden="true"></pre>
                  </div>
                </div>
              ` : `
                <div class="response-placeholder">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                  </svg>
                  <span>Ejecuta para ver la respuesta del servidor</span>
                </div>
              `}
              <pre id="jsonContent" style="display: none;"></pre>
            </div>
          </div>
        </div>
      `;

      // Update navigation
      document.getElementById('prevBtn').disabled = currentStep === 0;
      document.getElementById('nextBtn').disabled = currentStep === STEPS.length - 1;

      const nextStep = STEPS[currentStep + 1];
      document.getElementById('nextStepPreview').textContent = nextStep ? nextStep.title : 'Fin del taller';

      // Initialize workshop JSON editor highlighting and set editor mode
      if (resource) {
        updateWorkshopJsonHighlight();
        const responseBody = document.getElementById('responseBody');
        if (responseBody) {
          responseBody.classList.add('editor-mode');
          responseBody.classList.remove('response-mode');
        }
      }
    }

    let currentViewData = { request: null, response: null };
    let currentRequestView = 'request';

    function showRequestResponse(view) {
      currentRequestView = view;
      const buttons = document.querySelectorAll('.view-toggle-btn');
      buttons.forEach(btn => btn.classList.remove('active'));
      const targetBtn = buttons[view === 'request' ? 0 : 1];
      if (targetBtn) targetBtn.classList.add('active');

      const jsonContent = document.getElementById('jsonContent');
      const editorContainer = document.getElementById('workshopEditorContainer');
      const responseBody = document.getElementById('responseBody');
      const responsePlaceholder = document.querySelector('.response-placeholder');

      if (view === 'request') {
        // Show the editable workshop editor, hide the static jsonContent
        if (editorContainer) editorContainer.style.display = 'flex';
        if (jsonContent) jsonContent.style.display = 'none';
        if (responsePlaceholder) responsePlaceholder.style.display = 'flex';
        if (responseBody) {
          responseBody.classList.add('editor-mode');
          responseBody.classList.remove('response-mode');
        }
      } else {
        // Show response in jsonContent, hide the editor and placeholder
        if (editorContainer) editorContainer.style.display = 'none';
        if (responsePlaceholder) responsePlaceholder.style.display = 'none';
        if (jsonContent) {
          jsonContent.style.display = 'block';
          if (currentViewData.response) {
            jsonContent.innerHTML = syntaxHighlight(currentViewData.response);
          } else {
            jsonContent.innerHTML = '<span style="color: var(--text-muted);">Ejecuta el paso para ver la respuesta</span>';
          }
        }
        if (responseBody) {
          responseBody.classList.remove('editor-mode');
          responseBody.classList.add('response-mode');
        }
      }
    }

    // ==================== NAVIGATION ====================
    function goToStep(index) {
      if (index >= 0 && index < STEPS.length) {
        currentStep = index;
        currentViewData = { request: null, response: null };
        renderProgressBar();
        renderStep();
      }
    }

    function prevStep() {
      goToStep(currentStep - 1);
    }

    function nextStep() {
      goToStep(currentStep + 1);
    }

    // ==================== API FUNCTIONS ====================
    async function checkServerStatus() {
      const statusEl = document.getElementById('serverStatus');
      const textEl = document.getElementById('serverStatusText');

      try {
        const response = await fetch(`${FHIR_BASE}/metadata`, {
          method: 'GET',
          headers: { 'Accept': 'application/fhir+json' }
        });

        if (response.ok) {
          statusEl.classList.add('connected');
          textEl.textContent = 'Conectado';
        } else {
          throw new Error('Server error');
        }
      } catch (error) {
        statusEl.classList.remove('connected');
        textEl.textContent = 'Sin conexion';
      }
    }

    async function executeCurrentStep() {
      const step = STEPS[currentStep];
      stepStates[step.id] = 'loading';
      renderStep();
      renderProgressBar();

      try {
        let response, data;

        if (step.id === 'createPatients') {
          // Use edited patients array from workshop editor
          const patients = getEditedResource();
          const results = [];
          for (const patient of patients) {
            const res = await fetch(`${FHIR_BASE}/Patient`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/fhir+json',
                'Accept': 'application/fhir+json'
              },
              body: JSON.stringify(patient)
            });
            const patientData = await res.json();
            results.push({
              status: res.status,
              name: patient.name?.[0]?.family || 'Unknown',
              id: patientData.id || 'error'
            });
          }
          data = { message: "Pacientes creados", results };
          stepStates[step.id] = 'success';
        } else if (step.method === 'GET') {
          response = await fetch(`${FHIR_BASE}${step.endpoint}`, {
            method: 'GET',
            headers: { 'Accept': 'application/fhir+json' }
          });
          data = await response.json();
          stepStates[step.id] = response.ok ? 'success' : 'error';
        } else {
          // Use the edited resource from the workshop editor
          const resource = getEditedResource();
          response = await fetch(`${FHIR_BASE}${step.endpoint.split(' ')[0]}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/fhir+json',
              'Accept': 'application/fhir+json'
            },
            body: JSON.stringify(resource)
          });
          data = await response.json();

          let isSuccess = response.ok;
          if (data.resourceType === 'OperationOutcome') {
            const hasErrors = data.issue?.some(i => i.severity === 'error' || i.severity === 'fatal');
            isSuccess = !hasErrors;
          }
          stepStates[step.id] = isSuccess ? 'success' : 'error';
        }

        currentViewData.response = data;
        updateResponseUI(data);
      } catch (error) {
        stepStates[step.id] = 'error';
        currentViewData.response = { error: 'Error de conexion', message: error.message };
        updateResponseUI(currentViewData.response);
      }

      renderStep();
      renderProgressBar();
      showRequestResponse('response');
    }

    function updateResponseUI(data) {
      const badge = document.getElementById('statusBadge');
      const copyBtn = document.getElementById('copyBtn');

      badge.style.display = 'inline-block';
      copyBtn.style.display = 'flex';

      let badgeClass = 'success';
      let badgeText = 'OK';

      if (data.resourceType === 'OperationOutcome') {
        const hasErrors = data.issue?.some(i => i.severity === 'error' || i.severity === 'fatal');
        const hasWarnings = data.issue?.some(i => i.severity === 'warning');
        if (hasErrors) {
          badgeClass = 'error';
          badgeText = 'Validacion Fallida';
        } else if (hasWarnings) {
          badgeClass = 'warning';
          badgeText = 'Con Advertencias';
        } else {
          badgeText = 'Validacion OK';
        }
      } else if (data.error) {
        badgeClass = 'error';
        badgeText = 'Error';
      }

      badge.className = `status-badge ${badgeClass}`;
      badge.textContent = badgeText;
    }

    async function copyResponse() {
      if (!currentViewData.response) return;

      const btn = document.getElementById('copyBtn');
      const text = document.getElementById('copyBtnText');

      try {
        await navigator.clipboard.writeText(JSON.stringify(currentViewData.response, null, 2));
        btn.classList.add('copied');
        text.textContent = 'Copiado!';
        setTimeout(() => {
          btn.classList.remove('copied');
          text.textContent = 'Copiar';
        }, 2000);
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    }

    // ==================== THEME ====================
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
    }

    function initTheme() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
        document.documentElement.setAttribute('data-theme', savedTheme);
      } else {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (!prefersDark) {
          document.documentElement.setAttribute('data-theme', 'light');
        }
      }
    }

    // ==================== KEYBOARD NAVIGATION ====================
    document.addEventListener('keydown', (e) => {
      // Only handle keyboard navigation in workshop view
      const workshopView = document.getElementById('workshopView');
      if (!workshopView.classList.contains('active')) return;

      // Don't intercept keyboard events when typing in inputs or textareas
      const activeElement = document.activeElement;
      const isTyping = activeElement && (
        activeElement.tagName === 'TEXTAREA' ||
        activeElement.tagName === 'INPUT' ||
        activeElement.isContentEditable
      );

      if (e.key === 'ArrowLeft' && !isTyping) prevStep();
      else if (e.key === 'ArrowRight' && !isTyping) nextStep();
      else if (e.key === 'Enter' && !e.ctrlKey && !e.metaKey && !isTyping) executeCurrentStep();
    });

    // ==================== VIEW MANAGEMENT ====================
    let currentMainView = 'home';

    function showView(viewName) {
      currentMainView = viewName;

      // Hide all views
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));

      // Show selected view
      const viewEl = document.getElementById(viewName + 'View');
      if (viewEl) viewEl.classList.add('active');

      // Show/hide home button
      const homeBtn = document.getElementById('homeBtn');
      if (viewName === 'home') {
        homeBtn.classList.remove('visible');
      } else {
        homeBtn.classList.add('visible');
      }

      // Initialize workshop view if needed
      if (viewName === 'workshop') {
        renderProgressBar();
        renderStep();
      }
    }

    // ==================== LIVE TEST - FHIRPATH EVALUATION ====================
    const DEMO_RESOURCES = [
      {
        id: 'patient-chileno',
        title: 'Paciente Chileno',
        type: 'Patient',
        icon: 'patient',
        description: 'Paciente con RUT, nombre, telefonos y direccion',
        resource: {
          "resourceType": "Patient",
          "id": "ejemplo-chileno",
          "identifier": [{
            "system": "http://regcivil.cl/run",
            "value": "12345678-9"
          }],
          "active": true,
          "name": [{
            "use": "official",
            "family": "Gonzalez",
            "given": ["Juan", "Carlos"]
          }],
          "telecom": [
            {"system": "phone", "value": "+56912345678", "use": "mobile"},
            {"system": "email", "value": "juan@example.com", "use": "home"}
          ],
          "gender": "male",
          "birthDate": "1990-05-15",
          "address": [{
            "use": "home",
            "city": "Santiago",
            "country": "Chile"
          }]
        }
      },
      {
        id: 'observation-signos',
        title: 'Signos Vitales',
        type: 'Observation',
        icon: 'observation',
        description: 'Presion arterial con componentes sistolica/diastolica',
        resource: {
          "resourceType": "Observation",
          "id": "presion-arterial-1",
          "status": "final",
          "category": [{
            "coding": [{
              "system": "http://terminology.hl7.org/CodeSystem/observation-category",
              "code": "vital-signs",
              "display": "Vital Signs"
            }]
          }],
          "code": {
            "coding": [{
              "system": "http://loinc.org",
              "code": "85354-9",
              "display": "Blood pressure panel"
            }]
          },
          "subject": {"reference": "Patient/ejemplo-chileno"},
          "effectiveDateTime": "2024-01-15T10:30:00-03:00",
          "component": [
            {
              "code": {
                "coding": [{"system": "http://loinc.org", "code": "8480-6", "display": "Systolic blood pressure"}]
              },
              "valueQuantity": {"value": 120, "unit": "mmHg", "system": "http://unitsofmeasure.org", "code": "mm[Hg]"}
            },
            {
              "code": {
                "coding": [{"system": "http://loinc.org", "code": "8462-4", "display": "Diastolic blood pressure"}]
              },
              "valueQuantity": {"value": 80, "unit": "mmHg", "system": "http://unitsofmeasure.org", "code": "mm[Hg]"}
            }
          ]
        }
      },
      {
        id: 'condition-diabetes',
        title: 'Condicion Clinica',
        type: 'Condition',
        icon: 'condition',
        description: 'Diagnostico de Diabetes Mellitus tipo 2',
        resource: {
          "resourceType": "Condition",
          "id": "diabetes-tipo2",
          "clinicalStatus": {
            "coding": [{
              "system": "http://terminology.hl7.org/CodeSystem/condition-clinical",
              "code": "active"
            }]
          },
          "verificationStatus": {
            "coding": [{
              "system": "http://terminology.hl7.org/CodeSystem/condition-ver-status",
              "code": "confirmed"
            }]
          },
          "category": [{
            "coding": [{
              "system": "http://terminology.hl7.org/CodeSystem/condition-category",
              "code": "problem-list-item",
              "display": "Problem List Item"
            }]
          }],
          "severity": {
            "coding": [{
              "system": "http://snomed.info/sct",
              "code": "24484000",
              "display": "Severe"
            }]
          },
          "code": {
            "coding": [{
              "system": "http://snomed.info/sct",
              "code": "44054006",
              "display": "Diabetes mellitus type 2"
            }],
            "text": "Diabetes Mellitus Tipo 2"
          },
          "subject": {"reference": "Patient/ejemplo-chileno"},
          "onsetDateTime": "2020-03-15",
          "recordedDate": "2020-03-20"
        }
      },
      {
        id: 'medication-metformina',
        title: 'Medicamento',
        type: 'Medication',
        icon: 'medication',
        description: 'Metformina 850mg en tabletas',
        resource: {
          "resourceType": "Medication",
          "id": "metformina-850",
          "code": {
            "coding": [{
              "system": "http://snomed.info/sct",
              "code": "109081006",
              "display": "Metformin"
            }],
            "text": "Metformina 850mg"
          },
          "status": "active",
          "form": {
            "coding": [{
              "system": "http://snomed.info/sct",
              "code": "385055001",
              "display": "Tablet"
            }]
          },
          "ingredient": [{
            "itemCodeableConcept": {
              "coding": [{
                "system": "http://snomed.info/sct",
                "code": "109081006",
                "display": "Metformin"
              }]
            },
            "strength": {
              "numerator": {"value": 850, "unit": "mg", "system": "http://unitsofmeasure.org", "code": "mg"},
              "denominator": {"value": 1, "unit": "tablet", "system": "http://unitsofmeasure.org", "code": "{tablet}"}
            }
          }]
        }
      },
      {
        id: 'practitioner-medico',
        title: 'Profesional de Salud',
        type: 'Practitioner',
        icon: 'practitioner',
        description: 'Medico con RUT y especialidad',
        resource: {
          "resourceType": "Practitioner",
          "id": "medico-1",
          "identifier": [{
            "system": "http://regcivil.cl/run",
            "value": "15234567-8"
          }],
          "active": true,
          "name": [{
            "use": "official",
            "family": "Martinez",
            "given": ["Maria", "Elena"],
            "prefix": ["Dra."]
          }],
          "telecom": [
            {"system": "phone", "value": "+56922334455", "use": "work"},
            {"system": "email", "value": "dra.martinez@hospital.cl", "use": "work"}
          ],
          "gender": "female",
          "qualification": [{
            "code": {
              "coding": [{
                "system": "http://snomed.info/sct",
                "code": "309343006",
                "display": "Physician"
              }]
            }
          }]
        }
      },
      {
        id: 'bundle-busqueda',
        title: 'Bundle de Busqueda',
        type: 'Bundle',
        icon: 'bundle',
        description: 'Resultado de busqueda con multiples pacientes',
        resource: {
          "resourceType": "Bundle",
          "id": "busqueda-pacientes",
          "type": "searchset",
          "total": 2,
          "link": [{
            "relation": "self",
            "url": "http://example.org/fhir/Patient?family=Gonzalez"
          }],
          "entry": [
            {
              "fullUrl": "http://example.org/fhir/Patient/1",
              "resource": {
                "resourceType": "Patient",
                "id": "1",
                "name": [{"family": "Gonzalez", "given": ["Juan"]}],
                "gender": "male",
                "birthDate": "1990-05-15"
              }
            },
            {
              "fullUrl": "http://example.org/fhir/Patient/2",
              "resource": {
                "resourceType": "Patient",
                "id": "2",
                "name": [{"family": "Gonzalez", "given": ["Maria"]}],
                "gender": "female",
                "birthDate": "1985-08-22"
              }
            }
          ]
        }
      }
    ];

    function loadDemoResource(resourceId) {
      const resource = DEMO_RESOURCES.find(r => r.id === resourceId);
      if (resource) {
        const jsonInput = document.getElementById('jsonInput');
        jsonInput.value = JSON.stringify(resource.resource, null, 2);
        updateJsonHighlight();
        toggleResourceDrawer();
      }
    }

    function toggleResourceDrawer() {
      const drawer = document.getElementById('resourceDrawer');
      const overlay = document.getElementById('resourceDrawerOverlay');
      drawer.classList.toggle('open');
      overlay.classList.toggle('open');
    }

    function renderResourceList() {
      const list = document.getElementById('resourceList');
      if (!list) return;

      const icons = {
        patient: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
        observation: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>',
        condition: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg>',
        medication: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.5 20.5L3.5 13.5a4.95 4.95 0 1 1 7-7l7 7a4.95 4.95 0 1 1-7 7z"/><path d="M8.5 8.5l7 7"/></svg>',
        bundle: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>',
        practitioner: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 8v6"/><path d="M19 11h6"/></svg>'
      };

      list.innerHTML = DEMO_RESOURCES.map(r => `
        <div class="resource-item" onclick="loadDemoResource('${r.id}')">
          <div class="resource-item-header">
            <div class="resource-item-icon ${r.icon}">${icons[r.icon]}</div>
            <div>
              <div class="resource-item-title">${r.title}</div>
              <div class="resource-item-type">${r.type}</div>
            </div>
          </div>
          <div class="resource-item-description">${r.description}</div>
        </div>
      `).join('');
    }

    // Initialize resource list on page load
    document.addEventListener('DOMContentLoaded', renderResourceList);

    function updateJsonHighlight() {
      const jsonInput = document.getElementById('jsonInput');
      const jsonHighlight = document.getElementById('jsonHighlight');
      const jsonGutter = document.getElementById('jsonGutter');
      const text = jsonInput.value;

      if (!text) {
        jsonHighlight.innerHTML = '';
        if (jsonGutter) jsonGutter.innerHTML = '';
        return;
      }

      try {
        // Validate JSON but highlight the raw text to preserve formatting
        JSON.parse(text);
        jsonHighlight.innerHTML = syntaxHighlight(text);
      } catch (e) {
        // If invalid JSON, just escape HTML and show as-is
        jsonHighlight.innerHTML = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      }

      // Update line numbers
      generateLineNumbers(text, 'jsonGutter');

      // Sync scroll after content update
      requestAnimationFrame(() => syncScroll());

      evaluateExpression();
    }

    function syncScroll() {
      const jsonInput = document.getElementById('jsonInput');
      const jsonHighlight = document.getElementById('jsonHighlight');
      const jsonGutter = document.getElementById('jsonGutter');
      jsonHighlight.scrollTop = jsonInput.scrollTop;
      jsonHighlight.scrollLeft = jsonInput.scrollLeft;
      if (jsonGutter) {
        jsonGutter.scrollTop = jsonInput.scrollTop;
      }
    }

    function formatJsonInput() {
      const jsonInput = document.getElementById('jsonInput');
      const text = jsonInput.value.trim();

      if (!text) {
        return;
      }

      try {
        const parsed = JSON.parse(text);
        jsonInput.value = JSON.stringify(parsed, null, 2);
        updateJsonHighlight();
      } catch (e) {
        alert('JSON invalido: ' + e.message);
      }
    }

    function setExpression(expr) {
      const expressionInput = document.getElementById('expressionInput');
      expressionInput.value = expr;
      autoResizeExpression(expressionInput);
      evaluateExpression();
    }

    function autoResizeExpression(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 128) + 'px';
    }

    function evaluateExpression() {
      const jsonInput = document.getElementById('jsonInput');
      const expressionInput = document.getElementById('expressionInput');
      const resultPanel = document.getElementById('resultPanel');

      const jsonText = jsonInput.value.trim();
      const expression = expressionInput.value.trim();

      // Empty state
      if (!expression) {
        resultPanel.innerHTML = '<div class="result-empty"><p>Escribe una expresion FHIRPath para ver el resultado</p></div>';
        return;
      }

      // No JSON
      if (!jsonText) {
        resultPanel.innerHTML = '<div class="result-empty"><p>Pega un recurso FHIR en JSON para evaluar</p></div>';
        return;
      }

      try {
        // Parse JSON
        const resource = JSON.parse(jsonText);

        // Evaluate FHIRPath
        const result = fhirpath.evaluate(resource, expression);

        // Display result
        if (result.length === 0) {
          resultPanel.innerHTML = '<div class="result-empty"><p>Sin resultados (coleccion vacia)</p></div>';
        } else {
          resultPanel.innerHTML = '<pre>' + syntaxHighlight(result) + '</pre>';
        }
      } catch (error) {
        resultPanel.innerHTML = '<div class="result-error"><strong>Error:</strong> ' + error.message + '</div>';
      }
    }

    // ==================== INIT ====================
    initTheme();
    document.addEventListener('DOMContentLoaded', () => {
      checkServerStatus();
      setInterval(checkServerStatus, 30000);

      // Listen for JSON input changes
      const jsonInput = document.getElementById('jsonInput');
      if (jsonInput) {
        jsonInput.addEventListener('input', evaluateExpression);
      }
    });
  </script>
</body>
</html>
